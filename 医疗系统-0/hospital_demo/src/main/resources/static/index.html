<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»é™¢æŒ‚å·ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: #f5f7fa; }
        
        /* å¯¼èˆªæ  */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 15px 30px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar h1 { font-size: 24px; }
        .nav-links a {
            color: white; text-decoration: none; margin-left: 20px;
            padding: 8px 16px; border-radius: 20px; transition: background 0.3s;
        }
        .nav-links a:hover, .nav-links a.active { background: rgba(255,255,255,0.2); }
        
        /* ä¸»å®¹å™¨ */
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        
        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 20px;
        }
        .card-title {
            font-size: 18px; color: #333; margin-bottom: 15px;
            padding-bottom: 10px; border-bottom: 2px solid #667eea;
        }
        
        /* è¡¨å•æ ·å¼ */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #666; font-size: 14px; }
        .form-group select, .form-group input, .form-group textarea {
            width: 100%; padding: 10px 12px; border: 1px solid #ddd;
            border-radius: 8px; font-size: 14px; transition: border-color 0.3s;
        }
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus {
            outline: none; border-color: #667eea;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 10px 24px; border: none; border-radius: 8px;
            cursor: pointer; font-size: 14px; transition: all 0.3s;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a6fd6; }
        .btn-danger { background: #ff6b6b; color: white; }
        .btn-danger:hover { background: #ee5a5a; }
        .btn-success { background: #51cf66; color: white; }
        .btn-success:hover { background: #40c057; }
        .btn-warning { background: #fcc419; color: #333; }
        
        /* è¡¨æ ¼æ ·å¼ */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #666; font-weight: 600; }
        tr:hover { background: #f8f9fa; }
        
        /* æ ‡ç­¾æ ·å¼ */
        .tag {
            display: inline-block; padding: 4px 12px; border-radius: 20px;
            font-size: 12px; font-weight: 500;
        }
        .tag-normal { background: #e3f2fd; color: #1976d2; }
        .tag-emergency { background: #ffebee; color: #d32f2f; }
        .tag-booked { background: #e8f5e9; color: #388e3c; }
        .tag-completed { background: #f3e5f5; color: #7b1fa2; }
        .tag-cancelled { background: #fafafa; color: #757575; }
        
        /* ç½‘æ ¼å¸ƒå±€ */
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        @media (max-width: 768px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
        
        /* å·æºå¡ç‰‡ */
        .slot-card {
            border: 1px solid #eee; border-radius: 8px; padding: 15px;
            text-align: center; cursor: pointer; transition: all 0.3s;
        }
        .slot-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .slot-card.selected { border-color: #667eea; background: #f0f3ff; }
        .slot-card.disabled { opacity: 0.5; cursor: not-allowed; }
        .slot-time { font-size: 16px; font-weight: 600; color: #333; }
        .slot-info { font-size: 12px; color: #999; margin-top: 5px; }
        
        /* é¡µé¢åˆ‡æ¢ */
        .page { display: none; }
        .page.active { display: block; }
        
        /* æç¤ºä¿¡æ¯ */
        .alert {
            padding: 12px 16px; border-radius: 8px; margin-bottom: 15px;
        }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .alert-info { background: #cce5ff; color: #004085; }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stat-card {
            text-align: center; padding: 20px;
        }
        .stat-number { font-size: 36px; font-weight: 700; color: #667eea; }
        .stat-label { font-size: 14px; color: #999; margin-top: 5px; }
        
        /* éšè— */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <h1>ğŸ¥ åŒ»é™¢æŒ‚å·ç³»ç»Ÿ</h1>
        <div class="nav-links">
            <a href="#" onclick="showPage('home')" class="active" id="nav-home">é¦–é¡µ</a>
            <a href="#" onclick="showPage('appointment')" id="nav-appointment">æŒ‚å·</a>
            <a href="#" onclick="showPage('records')" id="nav-records">æˆ‘çš„æŒ‚å·</a>
            <a href="#" onclick="showPage('queue')" id="nav-queue">æ’é˜ŸæŸ¥è¯¢</a>
            <a href="#" onclick="showPage('admin')" id="nav-admin">ç®¡ç†</a>
        </div>
    </nav>

    <div class="container">
        <!-- é¦–é¡µ -->
        <div id="page-home" class="page active">
            <div class="card">
                <h2 class="card-title">ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h2>
                <div class="grid grid-3">
                    <div class="stat-card card">
                        <div class="stat-number" id="stat-today">0</div>
                        <div class="stat-label">ä»Šæ—¥æŒ‚å·æ•°</div>
                    </div>
                    <div class="stat-card card">
                        <div class="stat-number" id="stat-waiting">0</div>
                        <div class="stat-label">ç­‰å¾…å°±è¯Š</div>
                    </div>
                    <div class="stat-card card">
                        <div class="stat-number" id="stat-completed">0</div>
                        <div class="stat-label">å·²å®Œæˆå°±è¯Š</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">ğŸ¥ ç§‘å®¤åˆ—è¡¨</h2>
                <div class="grid grid-3" id="department-list"></div>
            </div>
        </div>


        <!-- æŒ‚å·é¡µé¢ -->
        <div id="page-appointment" class="page">
            <div class="card">
                <h2 class="card-title">ğŸ“ åœ¨çº¿æŒ‚å·</h2>
                <div id="appointment-alert"></div>
                
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>é€‰æ‹©ç—…äºº</label>
                        <select id="select-patient" onchange="onPatientChange()">
                            <option value="">-- è¯·é€‰æ‹©ç—…äºº --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é€‰æ‹©ç§‘å®¤</label>
                        <select id="select-department" onchange="loadDoctors()">
                            <option value="">-- è¯·é€‰æ‹©ç§‘å®¤ --</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>é€‰æ‹©åŒ»ç”Ÿ</label>
                        <select id="select-doctor" onchange="loadSlots()">
                            <option value="">-- è¯·å…ˆé€‰æ‹©ç§‘å®¤ --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é€‰æ‹©æ—¥æœŸ</label>
                        <input type="date" id="select-date" onchange="loadSlots()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>æŒ‚å·ç±»å‹</label>
                    <div style="display: flex; gap: 20px; margin-top: 5px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="appointment-type" value="æ™®é€š" checked style="margin-right: 8px;">
                            <span class="tag tag-normal">æ™®é€šæŒ‚å·</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="appointment-type" value="æ€¥è¯Š" style="margin-right: 8px;">
                            <span class="tag tag-emergency">æ€¥è¯ŠæŒ‚å·ï¼ˆä¼˜å…ˆå°±è¯Šï¼‰</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>é€‰æ‹©æ—¶é—´æ®µ</label>
                    <div class="grid grid-3" id="slot-list">
                        <p style="color: #999; grid-column: 1/-1;">è¯·å…ˆé€‰æ‹©åŒ»ç”Ÿå’Œæ—¥æœŸ</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ç—‡çŠ¶æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea id="symptoms" rows="3" placeholder="è¯·ç®€è¦æè¿°æ‚¨çš„ç—‡çŠ¶..."></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="submitAppointment()" style="width: 100%; padding: 15px; font-size: 16px;">
                    ç¡®è®¤æŒ‚å·
                </button>
            </div>
        </div>

        <!-- æˆ‘çš„æŒ‚å·è®°å½• -->
        <div id="page-records" class="page">
            <div class="card">
                <h2 class="card-title">ğŸ“‹ æˆ‘çš„æŒ‚å·è®°å½•</h2>
                <div class="form-group" style="max-width: 300px;">
                    <label>é€‰æ‹©ç—…äººæŸ¥çœ‹è®°å½•</label>
                    <select id="records-patient" onchange="loadPatientRecords()">
                        <option value="">-- è¯·é€‰æ‹©ç—…äºº --</option>
                    </select>
                </div>
                <div id="records-list">
                    <p style="color: #999; text-align: center; padding: 40px;">è¯·é€‰æ‹©ç—…äººæŸ¥çœ‹æŒ‚å·è®°å½•</p>
                </div>
            </div>
        </div>

        <!-- æ’é˜ŸæŸ¥è¯¢ -->
        <div id="page-queue" class="page">
            <div class="card">
                <h2 class="card-title">ğŸ“Š åŒ»ç”Ÿæ’é˜Ÿåˆ—è¡¨ï¼ˆæ€¥è¯Šä¼˜å…ˆï¼‰</h2>
                <div class="grid grid-2" style="max-width: 600px;">
                    <div class="form-group">
                        <label>é€‰æ‹©åŒ»ç”Ÿ</label>
                        <select id="queue-doctor" onchange="loadDoctorQueue()">
                            <option value="">-- è¯·é€‰æ‹©åŒ»ç”Ÿ --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é€‰æ‹©æ—¥æœŸ</label>
                        <input type="date" id="queue-date" onchange="loadDoctorQueue()">
                    </div>
                </div>
                <div id="queue-list">
                    <p style="color: #999; text-align: center; padding: 40px;">è¯·é€‰æ‹©åŒ»ç”Ÿå’Œæ—¥æœŸæŸ¥çœ‹æ’é˜Ÿæƒ…å†µ</p>
                </div>
            </div>
        </div>

        <!-- ç®¡ç†é¡µé¢ -->
        <div id="page-admin" class="page">
            <div class="card">
                <h2 class="card-title">âš™ï¸ ç³»ç»Ÿç®¡ç†</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showAdminTab('all')">æ‰€æœ‰æŒ‚å·</button>
                    <button class="btn btn-warning" onclick="showAdminTab('patients')">ç—…äººç®¡ç†</button>
                    <button class="btn btn-success" onclick="showAdminTab('doctors')">åŒ»ç”Ÿç®¡ç†</button>
                </div>
                <div id="admin-content"></div>
            </div>
        </div>
    </div>


    <script>
        // API åŸºç¡€è·¯å¾„
        const API_BASE = '/api';
        
        // å…¨å±€æ•°æ®
        let patients = [];
        let departments = [];
        let doctors = [];
        let selectedSlot = null;

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºæ˜å¤©
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateStr = tomorrow.toISOString().split('T')[0];
            document.getElementById('select-date').value = dateStr;
            document.getElementById('queue-date').value = new Date().toISOString().split('T')[0];
            
            // åŠ è½½åˆå§‹æ•°æ®
            loadPatients();
            loadDepartments();
            loadAllDoctors();
            loadStats();
        });

        // æ˜¾ç¤ºé¡µé¢
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            document.getElementById('nav-' + page).classList.add('active');
            
            if (page === 'admin') showAdminTab('all');
            if (page === 'records') {
                document.getElementById('records-patient').innerHTML = 
                    '<option value="">-- è¯·é€‰æ‹©ç—…äºº --</option>' +
                    patients.map(p => `<option value="${p.id}">${p.name} (${p.phone})</option>`).join('');
            }
        }

        // åŠ è½½ç—…äººåˆ—è¡¨
        async function loadPatients() {
            const res = await fetch(API_BASE + '/patients');
            const data = await res.json();
            if (data.code === 200) {
                patients = data.data;
                const options = '<option value="">-- è¯·é€‰æ‹©ç—…äºº --</option>' +
                    patients.map(p => `<option value="${p.id}">${p.name} (${p.phone})</option>`).join('');
                document.getElementById('select-patient').innerHTML = options;
                document.getElementById('records-patient').innerHTML = options;
            }
        }

        // åŠ è½½ç§‘å®¤åˆ—è¡¨
        async function loadDepartments() {
            const res = await fetch(API_BASE + '/departments');
            const data = await res.json();
            if (data.code === 200) {
                departments = data.data;
                document.getElementById('select-department').innerHTML = 
                    '<option value="">-- è¯·é€‰æ‹©ç§‘å®¤ --</option>' +
                    departments.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                
                // é¦–é¡µç§‘å®¤åˆ—è¡¨
                document.getElementById('department-list').innerHTML = 
                    departments.map(d => `
                        <div class="card slot-card" onclick="selectDepartment(${d.id})">
                            <div class="slot-time">${d.name}</div>
                            <div class="slot-info">${d.description || 'ä¸“ä¸šåŒ»ç–—æœåŠ¡'}</div>
                        </div>
                    `).join('');
            }
        }

        // åŠ è½½æ‰€æœ‰åŒ»ç”Ÿ
        async function loadAllDoctors() {
            const res = await fetch(API_BASE + '/doctors');
            const data = await res.json();
            if (data.code === 200) {
                doctors = data.data;
                document.getElementById('queue-doctor').innerHTML = 
                    '<option value="">-- è¯·é€‰æ‹©åŒ»ç”Ÿ --</option>' +
                    doctors.map(d => `<option value="${d.id}">${d.name} - ${d.title || 'åŒ»ç”Ÿ'}</option>`).join('');
            }
        }

        // æ ¹æ®ç§‘å®¤åŠ è½½åŒ»ç”Ÿ
        async function loadDoctors() {
            const deptId = document.getElementById('select-department').value;
            if (!deptId) {
                document.getElementById('select-doctor').innerHTML = '<option value="">-- è¯·å…ˆé€‰æ‹©ç§‘å®¤ --</option>';
                return;
            }
            const res = await fetch(API_BASE + '/doctors/department/' + deptId);
            const data = await res.json();
            if (data.code === 200) {
                document.getElementById('select-doctor').innerHTML = 
                    '<option value="">-- è¯·é€‰æ‹©åŒ»ç”Ÿ --</option>' +
                    data.data.map(d => `<option value="${d.id}">${d.name} - ${d.title || 'åŒ»ç”Ÿ'}</option>`).join('');
            }
        }

        // åŠ è½½å·æº
        async function loadSlots() {
            const doctorId = document.getElementById('select-doctor').value;
            const date = document.getElementById('select-date').value;
            if (!doctorId || !date) {
                document.getElementById('slot-list').innerHTML = '<p style="color: #999; grid-column: 1/-1;">è¯·å…ˆé€‰æ‹©åŒ»ç”Ÿå’Œæ—¥æœŸ</p>';
                return;
            }
            
            const res = await fetch(`${API_BASE}/slots/doctor/${doctorId}?date=${date}`);
            const data = await res.json();
            if (data.code === 200 && data.data.length > 0) {
                document.getElementById('slot-list').innerHTML = data.data.map(slot => {
                    const isEmergency = document.querySelector('input[name="appointment-type"]:checked').value === 'æ€¥è¯Š';
                    const canBook = isEmergency ? slot.canBookEmergency : slot.canBookNormal;
                    const available = isEmergency ? slot.availableEmergencySlots : slot.availableSlots;
                    return `
                        <div class="slot-card ${canBook ? '' : 'disabled'}" 
                             onclick="${canBook ? `selectSlot(this, '${slot.timeSlot}')` : ''}"
                             data-slot="${slot.timeSlot}">
                            <div class="slot-time">${slot.timeSlot}</div>
                            <div class="slot-info">å‰©ä½™: ${available} ä¸ªå·æº</div>
                        </div>
                    `;
                }).join('');
            } else {
                document.getElementById('slot-list').innerHTML = '<p style="color: #999; grid-column: 1/-1;">è¯¥æ—¥æœŸæš‚æ— å·æºï¼Œè¯·é€‰æ‹©å…¶ä»–æ—¥æœŸ</p>';
            }
            selectedSlot = null;
        }

        // é€‰æ‹©æ—¶é—´æ®µ
        function selectSlot(el, timeSlot) {
            document.querySelectorAll('#slot-list .slot-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            selectedSlot = timeSlot;
        }

        // æäº¤æŒ‚å·
        async function submitAppointment() {
            const patientId = document.getElementById('select-patient').value;
            const doctorId = document.getElementById('select-doctor').value;
            const departmentId = document.getElementById('select-department').value;
            const date = document.getElementById('select-date').value;
            const type = document.querySelector('input[name="appointment-type"]:checked').value;
            const symptoms = document.getElementById('symptoms').value;
            
            if (!patientId || !doctorId || !departmentId || !date || !selectedSlot) {
                showAlert('appointment-alert', 'è¯·å¡«å†™å®Œæ•´çš„æŒ‚å·ä¿¡æ¯', 'error');
                return;
            }
            
            // è§£ææ—¶é—´æ®µè·å–å¼€å§‹æ—¶é—´
            const startTime = selectedSlot.split('-')[0];
            
            const res = await fetch(API_BASE + '/appointments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    patientId: parseInt(patientId),
                    doctorId: parseInt(doctorId),
                    departmentId: parseInt(departmentId),
                    appointmentDate: date,
                    appointmentTime: startTime + ':00',
                    type: type,
                    symptoms: symptoms,
                    timeSlot: selectedSlot
                })
            });
            
            const data = await res.json();
            if (data.code === 200) {
                showAlert('appointment-alert', `æŒ‚å·æˆåŠŸï¼æ’é˜Ÿå·ç : ${data.data.queueNumber}`, 'success');
                loadSlots();
                loadStats();
            } else {
                showAlert('appointment-alert', data.message, 'error');
            }
        }

        // åŠ è½½ç—…äººæŒ‚å·è®°å½•
        async function loadPatientRecords() {
            const patientId = document.getElementById('records-patient').value;
            if (!patientId) {
                document.getElementById('records-list').innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">è¯·é€‰æ‹©ç—…äººæŸ¥çœ‹æŒ‚å·è®°å½•</p>';
                return;
            }
            
            const res = await fetch(API_BASE + '/appointments/patient/' + patientId);
            const data = await res.json();
            if (data.code === 200) {
                if (data.data.length === 0) {
                    document.getElementById('records-list').innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">æš‚æ— æŒ‚å·è®°å½•</p>';
                    return;
                }
                document.getElementById('records-list').innerHTML = `
                    <table>
                        <thead>
                            <tr><th>æ’é˜Ÿå·</th><th>ç§‘å®¤</th><th>åŒ»ç”Ÿ</th><th>æ—¥æœŸ</th><th>æ—¶é—´</th><th>ç±»å‹</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr>
                        </thead>
                        <tbody>
                            ${data.data.map(a => `
                                <tr>
                                    <td><strong>${a.queueNumber}</strong></td>
                                    <td>${a.departmentName}</td>
                                    <td>${a.doctorName}</td>
                                    <td>${a.appointmentDate}</td>
                                    <td>${a.timeSlot || ''}</td>
                                    <td><span class="tag ${a.type === 'æ€¥è¯Š' ? 'tag-emergency' : 'tag-normal'}">${a.type}</span></td>
                                    <td><span class="tag tag-${getStatusClass(a.status)}">${a.status}</span></td>
                                    <td>${a.canCancel ? `<button class="btn btn-danger" onclick="cancelAppointment(${a.id})">å–æ¶ˆ</button>` : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
        }

        // åŠ è½½åŒ»ç”Ÿæ’é˜Ÿåˆ—è¡¨
        async function loadDoctorQueue() {
            const doctorId = document.getElementById('queue-doctor').value;
            const date = document.getElementById('queue-date').value;
            if (!doctorId || !date) return;
            
            const res = await fetch(`${API_BASE}/appointments/queue/${doctorId}?date=${date}`);
            const data = await res.json();
            if (data.code === 200) {
                if (data.data.length === 0) {
                    document.getElementById('queue-list').innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">è¯¥æ—¥æœŸæš‚æ— æ’é˜Ÿè®°å½•</p>';
                    return;
                }
                document.getElementById('queue-list').innerHTML = `
                    <div class="alert alert-info">ğŸ’¡ æ€¥è¯Šæ‚£è€…ä¼˜å…ˆå°±è¯Šï¼ŒæŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°ä½æ’åº</div>
                    <table>
                        <thead>
                            <tr><th>æ’é˜Ÿå·</th><th>ç—…äºº</th><th>ç±»å‹</th><th>ä¼˜å…ˆçº§</th><th>é¢„çº¦æ—¶é—´</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr>
                        </thead>
                        <tbody>
                            ${data.data.map((a, i) => `
                                <tr style="${a.type === 'æ€¥è¯Š' ? 'background: #fff5f5;' : ''}">
                                    <td><strong>${i + 1}</strong> (${a.queueNumber})</td>
                                    <td>${a.patientName}</td>
                                    <td><span class="tag ${a.type === 'æ€¥è¯Š' ? 'tag-emergency' : 'tag-normal'}">${a.type}</span></td>
                                    <td>${a.priority}</td>
                                    <td>${a.timeSlot || ''}</td>
                                    <td><span class="tag tag-${getStatusClass(a.status)}">${a.status}</span></td>
                                    <td>${a.status === 'å·²é¢„çº¦' ? `<button class="btn btn-success" onclick="completeAppointment(${a.id})">å®Œæˆå°±è¯Š</button>` : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
        }

        // å–æ¶ˆæŒ‚å·
        async function cancelAppointment(id) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªæŒ‚å·å—ï¼Ÿ')) return;
            const res = await fetch(API_BASE + '/appointments/' + id, { method: 'DELETE' });
            const data = await res.json();
            alert(data.message);
            loadPatientRecords();
            loadStats();
        }

        // å®Œæˆå°±è¯Š
        async function completeAppointment(id) {
            const res = await fetch(`${API_BASE}/appointments/${id}/complete`, { method: 'PUT' });
            const data = await res.json();
            alert(data.message);
            loadDoctorQueue();
            loadStats();
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            const res = await fetch(API_BASE + '/appointments');
            const data = await res.json();
            if (data.code === 200) {
                const today = new Date().toISOString().split('T')[0];
                const todayAppts = data.data.filter(a => a.appointmentDate === today);
                document.getElementById('stat-today').textContent = todayAppts.length;
                document.getElementById('stat-waiting').textContent = data.data.filter(a => a.status === 'å·²é¢„çº¦').length;
                document.getElementById('stat-completed').textContent = data.data.filter(a => a.status === 'å·²å°±è¯Š').length;
            }
        }

        // ç®¡ç†é¡µé¢æ ‡ç­¾åˆ‡æ¢
        async function showAdminTab(tab) {
            if (tab === 'all') {
                const res = await fetch(API_BASE + '/appointments');
                const data = await res.json();
                if (data.code === 200) {
                    document.getElementById('admin-content').innerHTML = `
                        <table>
                            <thead><tr><th>ID</th><th>ç—…äºº</th><th>ç§‘å®¤</th><th>åŒ»ç”Ÿ</th><th>æ—¥æœŸ</th><th>ç±»å‹</th><th>çŠ¶æ€</th></tr></thead>
                            <tbody>${data.data.map(a => `
                                <tr>
                                    <td>${a.id}</td><td>${a.patientName}</td><td>${a.departmentName}</td>
                                    <td>${a.doctorName}</td><td>${a.appointmentDate}</td>
                                    <td><span class="tag ${a.type === 'æ€¥è¯Š' ? 'tag-emergency' : 'tag-normal'}">${a.type}</span></td>
                                    <td><span class="tag tag-${getStatusClass(a.status)}">${a.status}</span></td>
                                </tr>
                            `).join('')}</tbody>
                        </table>
                    `;
                }
            } else if (tab === 'patients') {
                document.getElementById('admin-content').innerHTML = `
                    <table>
                        <thead><tr><th>ID</th><th>å§“å</th><th>æ‰‹æœºå·</th><th>æ€§åˆ«</th><th>å¹´é¾„</th></tr></thead>
                        <tbody>${patients.map(p => `
                            <tr><td>${p.id}</td><td>${p.name}</td><td>${p.phone}</td><td>${p.gender || '-'}</td><td>${p.age || '-'}</td></tr>
                        `).join('')}</tbody>
                    </table>
                `;
            } else if (tab === 'doctors') {
                document.getElementById('admin-content').innerHTML = `
                    <table>
                        <thead><tr><th>ID</th><th>å§“å</th><th>èŒç§°</th><th>ä¸“é•¿</th><th>æ’ç­</th></tr></thead>
                        <tbody>${doctors.map(d => `
                            <tr><td>${d.id}</td><td>${d.name}</td><td>${d.title || '-'}</td><td>${d.specialty || '-'}</td><td>${d.schedule || '-'}</td></tr>
                        `).join('')}</tbody>
                    </table>
                `;
            }
        }

        // é€‰æ‹©ç§‘å®¤è·³è½¬æŒ‚å·
        function selectDepartment(deptId) {
            showPage('appointment');
            document.getElementById('select-department').value = deptId;
            loadDoctors();
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusClass(status) {
            const map = { 'å·²é¢„çº¦': 'booked', 'å·²å°±è¯Š': 'completed', 'å·²å–æ¶ˆ': 'cancelled', 'å·²è¿‡æœŸ': 'cancelled' };
            return map[status] || 'booked';
        }

        // æŒ‚å·ç±»å‹åˆ‡æ¢æ—¶åˆ·æ–°å·æº
        document.querySelectorAll('input[name="appointment-type"]').forEach(radio => {
            radio.addEventListener('change', loadSlots);
        });
    </script>
</body>
</html>
